<?php

/**
 * @file
 * Helper functions.
 */

module_load_include("inc", "novo_reports", "includes/novo_reports.handlers_func");

/**
 * Implements hook_menu().
 */
function novo_reports_menu() {
  $items = array();

  $items['novo-reports'] = array(
    // @codingStandardsIgnoreStart
    'title' => t('Reports'),
    // @codingStandardsIgnoreEnd
    'access arguments' => array('novo reports access'),
    'page callback' => 'novo_reports_list',
    'menu_name' => 'main-menu',
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}

/**
 * Reports list from views list.
 */
function novo_reports_list() {
  if ($cached = cache_get('novo_reports:list')) {
    return $cached->data;
  }

  $views = views_get_all_views();
  $links = array();

  foreach ($views as $view_name => $view) {
    if (strtolower($view->tag) == "report") {
      $path = isset($view->display['page']->display_options['path']) ? $view->display['page']->display_options['path'] : NULL;
      if ($path) {
        $title = $view->human_name;

        $export_links = array();
        foreach ($view->display as $key => $display) {
          if (in_array($display->display_plugin, array(
            "views_data_export_pdf",
            "views_data_export"
          ))) {
            $export_path = isset($view->display[$key]->display_options['path']) ? $view->display[$key]->display_options['path'] : NULL;
            $style_plugin = isset($view->display[$key]->display_options['style_plugin']) ? $view->display[$key]->display_options['style_plugin'] : NULL;
            $display_plugin = isset($view->display[$key]->display_plugin) ? $view->display[$key]->display_plugin : NULL;

            switch ($display_plugin) {
              case "views_data_export_pdf":
                $image_path = drupal_get_path("module", "views_data_export_pdf") . "/images/pdf.png";
                $type = "pdf";
                break;

              case "views_data_export":
                switch ($style_plugin) {
                  case "views_data_export_xls":
                    $image_path = drupal_get_path("module", "views_data_export") . "/images/xls.png";
                    $type = "xls";
                    break;

                  default:
                    $type = "";
                    $image_path = "";
                }
                break;

              default:
                $type = "";
                $image_path = "";
            }

            if (!empty($export_path)) {
              $theme_pattern = array(
                'views_data_export_feed_icon__' . $type,
                'views_data_export_feed_icon',
              );

              $export_links[] = theme($theme_pattern, array(
                  'image_path' => $image_path,
                  'url' => $export_path,
                  'text' => $view->human_name,
                  'title' => $view->human_name,
                  'style_plugin' => $style_plugin
                )
              );
            }

          }
        }

        if (!empty($export_links)) {
          $title .= " " . implode(" ", $export_links);
        }

        $links[] = array(
          'href' => $path,
          'title' => $title,
          'html' => TRUE
        );
      }
    }
  }

  $links = theme("links", array(
    "links" => $links,
    "attributes" => array("class" => array("novo-reports-list-wrapper")),
    "heading" => ""
  ));
  cache_set('novo_reports:list', $links);

  return $links;
}

/**
 * Implements hook_permission().
 */
function novo_reports_permission() {
  return array(
    'novo reports access' => array(
      'title' => t('Novo access to reports.'),
      'description' => t('Novo access to reports.'),
    ),
  );
}

/**
 * Get all reports paths.
 */
function novo_reports_get_report_view_list_paths() {
  if ($cached = cache_get('novo_reports:get_report_view_list_paths')) {
    return $cached->data;
  }

  $views = views_get_all_views();
  $paths = array();
  foreach ($views as $view_name => $view) {
    if (strtolower($view->tag) == "report") {
      if (isset($view->display['page']->display_options['path'])) {
        $paths[] = $view->display['page']->display_options['path'];
      }
    }
  }
  cache_set('novo_reports:get_report_view_list_paths', $paths);

  return $paths;
}

/**
 * Implements hook_views_api().
 */
function novo_reports_views_api() {
  return array(
    'api' => 3,
    'path' => drupal_get_path('module', 'novo_reports') . '/views',
  );
}
